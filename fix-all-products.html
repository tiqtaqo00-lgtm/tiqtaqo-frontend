<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <title>Ø¥ØµÙ„Ø§Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª - TiqtaQo</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background: #1a1a2e; color: white; }
        h1 { color: #d4af37; text-align: center; }
        .card { background: #16213e; border-radius: 10px; padding: 20px; margin: 20px 0; }
        .btn { width: 100%; padding: 15px; background: #e74c3c; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 18px; margin: 10px 0; }
        .btn:hover { background: #c0392b; }
        .btn:disabled { background: #7f8c8d; cursor: not-allowed; }
        .log { background: #0f0f23; padding: 15px; border-radius: 8px; font-family: monospace; font-size: 13px; max-height: 300px; overflow-y: auto; white-space: pre-wrap; color: #00ff00; }
        .status { padding: 15px; border-radius: 8px; margin: 10px 0; text-align: center; }
        .status.success { background: #27ae60; }
        .status.error { background: #e74c3c; }
        .status.info { background: #3498db; }
        .count { display: inline-block; padding: 10px 20px; background: #d4af37; color: black; border-radius: 20px; margin: 5px; font-weight: bold; }
        .warning { background: #f39c12; color: black; padding: 15px; border-radius: 8px; margin: 20px 0; }
    </style>
</head>
<body>
    <h1>ğŸ”§ Ø¥ØµÙ„Ø§Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø¯ÙØ¹Ø© ÙˆØ§Ø­Ø¯Ø©</h1>
    
    <div class="warning">
        <strong>âš ï¸ ØªØ­Ø°ÙŠØ± Ù‡Ø§Ù…:</strong><br>
        Ù‡Ø°Ø§ Ø³ÙŠØºÙŠÙŠØ± gender Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø¥Ù„Ù‰ "femme"<br>
        Ø¥Ø°Ø§ ÙƒØ§Ù† Ù„Ø¯ÙŠÙƒ Ù…Ù†ØªØ¬Ø§Øª Ù„Ù„Ø±Ø¬Ø§Ù„ØŒ Ø³ØªØ­ØªØ§Ø¬ Ù„ØªØºÙŠÙŠØ±Ù‡Ø§ ÙŠØ¯ÙˆÙŠØ§Ù‹ Ù„Ø§Ø­Ù‚Ø§Ù‹
    </div>
    
    <div class="card">
        <h2>ğŸ“Š Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h2>
        <div id="stats">
            <p>â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª...</p>
        </div>
    </div>
    
    <div class="card">
        <h2>ğŸ”§ Ø§Ù„Ø¥ØµÙ„Ø§Ø­</h2>
        <button class="btn" id="fixBtn" onclick="fixAllProducts()">ğŸš€ Ø¥ØµÙ„Ø§Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø¢Ù†</button>
        <div id="status"></div>
    </div>
    
    <div class="card">
        <h2>ğŸ“ Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</h2>
        <div class="log" id="log">Ø§Ù†ØªØ¸Ø±...</div>
    </div>

    <script type="module">
        import { db, collection, getDocs, doc, updateDoc } from './js/firebase-config.js';
        
        let allProducts = [];
        
        function log(msg) {
            const logEl = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            logEl.textContent += `\n[${time}] ${msg}`;
            logEl.scrollTop = logEl.scrollHeight;
        }
        
        async function loadProducts() {
            log('Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Firebase...');
            
            try {
                const productsRef = collection(db, 'products');
                const snapshot = await getDocs(productsRef);
                
                allProducts = [];
                snapshot.forEach(doc => {
                    allProducts.push({ id: doc.id, ...doc.data() });
                });
                
                const incorrect = allProducts.filter(p => {
                    const g = (p.gender || '').trim();
                    return g !== 'femme' && g !== 'homme';
                });
                
                document.getElementById('stats').innerHTML = `
                    <p><span class="count">${allProducts.length}</span> Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</p>
                    <p><span class="count" style="background: #e74c3c;">${incorrect.length}</span> Ù…Ù†ØªØ¬Ø§Øª ØªØ­ØªØ§Ø¬ Ø¥ØµÙ„Ø§Ø­</p>
                    <p><span class="count" style="background: #27ae60;">${allProducts.length - incorrect.length}</span> Ù…Ù†ØªØ¬Ø§Øª ØµØ­ÙŠØ­Ø©</p>
                `;
                
                log(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${allProducts.length} Ù…Ù†ØªØ¬`);
                log(`${incorrect.length} Ù…Ù†ØªØ¬ ÙŠØ­ØªØ§Ø¬ Ø¥ØµÙ„Ø§Ø­`);
                
                if (incorrect.length === 0) {
                    document.getElementById('status').innerHTML = '<div class="status success">âœ… Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ØµØ­ÙŠØ­Ø©! Ù„Ø§ Ø­Ø§Ø¬Ø© Ù„Ù„Ø¥ØµÙ„Ø§Ø­.</div>';
                    document.getElementById('fixBtn').style.display = 'none';
                }
                
            } catch (error) {
                log(`âŒ Ø®Ø·Ø£: ${error.message}`);
                document.getElementById('stats').innerHTML = `<div class="status error">Ø®Ø·Ø£: ${error.message}</div>`;
            }
        }
        
        window.fixAllProducts = async function() {
            const btn = document.getElementById('fixBtn');
            const status = document.getElementById('status');
            
            btn.disabled = true;
            btn.textContent = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥ØµÙ„Ø§Ø­...';
            status.innerHTML = '<div class="status info">Ø¬Ø§Ø±ÙŠ Ø¥ØµÙ„Ø§Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª...</div>';
            log('ğŸš€ Ø¨Ø¯Ø£Øª Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¥ØµÙ„Ø§Ø­');
            
            let fixed = 0;
            let errors = [];
            
            for (const p of allProducts) {
                const currentGender = (p.gender || '').trim();
                
                // Only fix if gender is not 'femme' or 'homme'
                if (currentGender !== 'femme' && currentGender !== 'homme') {
                    try {
                        await updateDoc(doc(db, 'products', p.id), {
                            gender: 'femme'
                        });
                        
                        fixed++;
                        log(`âœ… ØªÙ… Ø¥ØµÙ„Ø§Ø­: ${p.name || p.id} (gender: "${currentGender}" â†’ "femme")`);
                        
                    } catch (error) {
                        errors.push(`${p.name || p.id}: ${error.message}`);
                        log(`âŒ Ø®Ø·Ø£ ÙÙŠ ${p.name || p.id}: ${error.message}`);
                    }
                }
            }
            
            btn.textContent = 'âœ… ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡';
            
            if (errors.length === 0) {
                status.innerHTML = `<div class="status success">ğŸ‰ ØªÙ… Ø¥ØµÙ„Ø§Ø­ ${fixed} Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­!</div>`;
                log(`\nğŸ‰ Ù†Ø¬Ø­! ØªÙ… Ø¥ØµÙ„Ø§Ø­ ${fixed} Ù…Ù†ØªØ¬`);
            } else {
                status.innerHTML = `
                    <div class="status error">
                        <p>âœ… ØªÙ… Ø¥ØµÙ„Ø§Ø­ ${fixed} Ù…Ù†ØªØ¬</p>
                        <p>âŒ ${errors.length} Ø®Ø·Ø£</p>
                        <p>${errors.join(', ')}</p>
                    </div>
                `;
            }
            
            // Refresh after 3 seconds
            setTimeout(() => location.reload(), 3000);
        };
        
        // Start
        loadProducts();
    </script>
</body>
</html>
