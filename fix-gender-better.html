<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ´Ø®ÙŠØµ ÙˆØ¥ØµÙ„Ø§Ø­ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª - TiqtaQo</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1000px; margin: 0 auto; padding: 20px; background: #f5f5f5; }
        .card { background: white; border-radius: 10px; padding: 20px; margin: 20px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .card h2 { margin-top: 0; color: #333; }
        .product-item { background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 8px; border-right: 4px solid #e74c3c; }
        .product-item.correct { border-right-color: #27ae60; }
        .product-item.incorrect { border-right-color: #e74c3c; }
        .product-name { font-weight: bold; font-size: 16px; }
        .product-detail { margin: 5px 0; color: #666; }
        .product-detail span { font-weight: bold; color: #333; }
        .btn { background: #3498db; color: white; border: none; padding: 15px 30px; border-radius: 8px; cursor: pointer; font-size: 16px; margin: 10px 5px; }
        .btn:hover { background: #2980b9; }
        .btn.fix { background: #e74c3c; }
        .btn.fix:hover { background: #c0392b; }
        .btn:disabled { background: #95a5a6; cursor: not-allowed; }
        .status { padding: 15px; border-radius: 8px; margin: 10px 0; }
        .status.loading { background: #fff3cd; color: #856404; }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .log-box { background: #2c3e50; color: #00ff00; padding: 15px; border-radius: 8px; font-family: monospace; font-size: 13px; max-height: 300px; overflow-y: auto; white-space: pre-wrap; }
        .count-box { display: inline-block; background: #3498db; color: white; padding: 5px 15px; border-radius: 20px; margin: 5px; }
        .count-box.incorrect { background: #e74c3c; }
        .count-box.correct { background: #27ae60; }
    </style>
</head>
<body>
    <h1>ğŸ”§ ØªØ´Ø®ÙŠØµ ÙˆØ¥ØµÙ„Ø§Ø­ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h1>
    
    <div class="card">
        <h2>ğŸ“Š Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h2>
        <div id="stats">
            <span class="count-box loading">â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
        </div>
    </div>
    
    <div class="card" id="productsCard" style="display: none;">
        <h2>ğŸ“‹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h2>
        <div id="productsList"></div>
    </div>
    
    <div class="card">
        <h2>ğŸ”§ Ø¥ØµÙ„Ø§Ø­</h2>
        <p id="fixDescription">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø± Ø£Ø¯Ù†Ø§Ù‡ Ù„ØªØºÙŠÙŠØ± gender Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø¥Ù„Ù‰ "femme"</p>
        <button class="btn fix" id="fixBtn" onclick="fixProducts()">ğŸ”§ Ø¥ØµÙ„Ø§Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</button>
        <div id="fixStatus"></div>
    </div>
    
    <div class="card">
        <h2>ğŸ“ Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</h2>
        <div class="log-box" id="logBox">Ø§Ù†ØªØ¸Ø±... Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</div>
    </div>

    <script type="module">
        import { db, collection, getDocs, doc, updateDoc } from './js/firebase-config.js';
        
        let allProducts = [];
        
        function log(message) {
            const logBox = document.getElementById('logBox');
            const time = new Date().toLocaleTimeString();
            logBox.textContent += `\n[${time}] ${message}`;
            logBox.scrollTop = logBox.scrollHeight;
            console.log(message);
        }
        
        async function loadProducts() {
            log('Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Firebase...');
            
            try {
                const productsRef = collection(db, 'products');
                const snapshot = await getDocs(productsRef);
                
                allProducts = [];
                snapshot.forEach(doc => {
                    allProducts.push({ id: doc.id, ...doc.data() });
                });
                
                log(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${allProducts.length} Ù…Ù†ØªØ¬`);
                displayProducts();
                
            } catch (error) {
                log(`âŒ Ø®Ø·Ø£: ${error.message}`);
                document.getElementById('stats').innerHTML = `<div class="status error">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: ${error.message}</div>`;
            }
        }
        
        function displayProducts() {
            const statsDiv = document.getElementById('stats');
            const productsListDiv = document.getElementById('productsList');
            const productsCard = document.getElementById('productsCard');
            
            // Count correct vs incorrect
            let correct = 0;
            let incorrect = 0;
            
            const productsHTML = allProducts.map(p => {
                const gender = (p.gender || '').trim();
                const isCorrect = gender === 'femme' || gender === 'homme';
                
                if (isCorrect) correct++;
                else incorrect++;
                
                return `
                    <div class="product-item ${isCorrect ? 'correct' : 'incorrect'}">
                        <div class="product-name">${p.name || 'Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…'}</div>
                        <div class="product-detail">Ø§Ù„ÙØ¦Ø©: <span>${p.category || 'N/A'}</span></div>
                        <div class="product-detail">gender Ø§Ù„Ø­Ø§Ù„ÙŠ: <span style="color: ${isCorrect ? '#27ae60' : '#e74c3c'}">"${p.gender}"</span></div>
                        <div class="product-detail">Ø§Ù„Ù…Ø´ÙƒÙ„Ø©: ${isCorrect ? 'âœ… ØµØ­ÙŠØ­' : 'âŒ gender ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† "femme" Ø£Ùˆ "homme"'}</div>
                    </div>
                `;
            }).join('');
            
            statsDiv.innerHTML = `
                <span class="count-box">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: ${allProducts.length}</span>
                <span class="count-box correct">ØµØ­ÙŠØ­: ${correct}</span>
                <span class="count-box incorrect">ÙŠØ­ØªØ§Ø¬ Ø¥ØµÙ„Ø§Ø­: ${incorrect}</span>
            `;
            
            productsListDiv.innerHTML = productsHTML;
            productsCard.style.display = 'block';
            
            log(`ØµØ­ÙŠØ­: ${correct} | ÙŠØ­ØªØ§Ø¬ Ø¥ØµÙ„Ø§Ø­: ${incorrect}`);
        }
        
        window.fixProducts = async function() {
            const fixBtn = document.getElementById('fixBtn');
            const fixStatus = document.getElementById('fixStatus');
            
            fixBtn.disabled = true;
            fixBtn.textContent = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥ØµÙ„Ø§Ø­...';
            
            fixStatus.innerHTML = '<div class="status loading">Ø¬Ø§Ø±ÙŠ Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª...</div>';
            log('Ø¨Ø¯Ø£ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¥ØµÙ„Ø§Ø­...');
            
            let fixed = 0;
            let errors = [];
            
            for (const p of allProducts) {
                const gender = (p.gender || '').trim();
                
                // Only fix if gender is not 'femme' or 'homme'
                if (gender !== 'femme' && gender !== 'homme') {
                    try {
                        await updateDoc(doc(db, 'products', p.id), {
                            gender: 'femme'
                        });
                        
                        fixed++;
                        log(`âœ… ØªÙ… Ø¥ØµÙ„Ø§Ø­: ${p.name}`);
                        
                    } catch (error) {
                        errors.push(`${p.name}: ${error.message}`);
                        log(`âŒ Ø®Ø·Ø£ ÙÙŠ ${p.name}: ${error.message}`);
                    }
                }
            }
            
            fixBtn.textContent = 'ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©';
            fixBtn.disabled = false;
            fixBtn.onclick = () => location.reload();
            
            if (errors.length === 0) {
                fixStatus.innerHTML = `<div class="status success">âœ… ØªÙ… Ø¥ØµÙ„Ø§Ø­ ${fixed} Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­!</div>`;
                log(`ğŸ‰ ØªÙ… Ø¥ØµÙ„Ø§Ø­ ${fixed} Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­!`);
            } else {
                fixStatus.innerHTML = `
                    <div class="status error">
                        <p>ØªÙ… Ø¥ØµÙ„Ø§Ø­ ${fixed} Ù…Ù†ØªØ¬</p>
                        <p>Ø£Ø®Ø·Ø§Ø¡: ${errors.length}</p>
                        <p>${errors.join('<br>')}</p>
                    </div>
                `;
            }
        };
        
        // Start loading
        loadProducts();
    </script>
</body>
</html>
